#!/bin/sh
#
# experimental setup script

die() { echo "$*" 1>&2 ; exit 1; }
warn() { echo "$*" 1>&2 ; }

cd $HOME

# clear out home
rm -rf $HOME/* || warn "failed to clear out home directory"

# setup home filesystem
mkdir $HOME/{coding/iso_store/roms,dl/torrent,docs/org,kb,media/{music,pictures/{screenshots},videos}} || warn "failed to create home directories"

# clone dotfiles
git clone --bare https://github.com/bcmertz/dotfiles.git $HOME/.cfg || die "failed to clone dotfiles"

# alias git commands and checkout files
alias cfg='/usr/bin/git --git-dir=$HOME/.cfg/ --work-tree=$HOME'
cfg checkout -f || die "failed to checkout local dotfiles"

# install packages
sudo pacman -Syu yay || die "please manually install yay" # in endeavour os repos
yay -S --needed - < $HOME/.local/share/packages/packages.txt || warn "failed to install packages"

# suckless utilities
git clone https://github.com/bcmertz/dmenu.git $HOME/coding/dmenu || warn "failed to clone dmenu"
cd $HOME/coding/dmenu
sudo make clean install || warn "failed to install dmenu"
cd $HOME

git clone https://github.com/bcmertz/st.git $HOME/coding/st || warn "failed to clone st"
cd $HOME/coding/st
sudo make clean install || warn "failed to install st"
cd $HOME

# setup passwords
ssh-keygen -t rsa -C "bennett.mertz@gmail.com"
cat .ssh/id_rsa.pub
echo "Upload ssh public key to github. Press any key to continue"
while [ true ] ; do
    read -t 3 -n 1
    if [ $? = 0 ] ; then
        exit
    fi
done
git clone https://github.com/bcmertz/passwords.git || warn "failed to download passwords"
setuppass || warn "failed to setup gpg / passwords"

# use our local passmenu
sudo rm /usr/bin/passenu

# setup crons
crontab $HOME/.local/bin/cron/crontabbackup.txt || warn "failed to create setup cron"
sudo systemctl enable --now cronie.service  || warn "failed to enable cron service"

# TODO: setupUFW

# TODO: config grub?

# touchegg gestures
sudo systemctl enable --now touchegg.service || warn "failed to setup touchegg service"

# printing
sudo systemctl enable --now cups.socket || warn "failed to setup printing service"

# fonts
fc-cache -f -v || warn "failed to regenerate font cache"

# transmission
sudo chmod 770 $HOME/{media/{music,videos},dl/torrent,coding/iso_store,coding/iso_store/roms}
sudo usermod -a -G transmission leah
