#!/bin/sh
#
# copy URL of active firefox tab, then start new search of that site

id=$(xdotool getactivewindow)
class_name=$(xdotool getwindowclassname $id)

if [ $class_name != "firefox" ]; then
    notify-send "not in firefox"
    exit
fi

xdotool windowactivate --sync $id key --window $id --clearmodifiers F6 Ctrl+c F6

url=$(xclip -o -selection clipboard)
xsel -bc
xsel -c # clear clipboard

case "$url" in
    *reddit*)
        # just search on the subreddit name
        # last bit matches everything except forward slash /
        url=$(echo $url | grep -o '.*reddit.com\/r\/[^\/]*')
        ;;
    *)
        url=$(echo $url | grep -o '.*.com\/')
        echo $url
        ;;
esac

# prevent modifier keys from not being released
xdotool keyup Shift_L Shift_R Control_L Control_R Meta_L Meta_R Alt_L Alt_R Super_L Super_R Hyper_L Hyper_R ISO_Level2_Latch ISO_Level3_Shift ISO_Level3_Latch ISO_Level3_Lock ISO_Level5_Shift ISO_Level5_Latch ISO_Level5_Lock

query=$(printf "" | dmenu -c -i -l 20 -p 'search:' -bw 3)
search="site:${url} ${query}"

xdotool key --window $id --clearmodifiers Ctrl+t
xdotool type --window $id --clearmodifiers "$search"
xdotool key --window $id --clearmodifiers Enter
xdotool keyup Shift_L Shift_R Control_L Control_R Meta_L Meta_R Alt_L Alt_R Super_L Super_R Hyper_L Hyper_R ISO_Level2_Latch ISO_Level3_Shift ISO_Level3_Latch ISO_Level3_Lock ISO_Level5_Shift ISO_Level5_Latch ISO_Level5_Lock
